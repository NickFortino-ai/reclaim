generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String    @id @default(cuid())
  accessCode      String    @unique
  referralCode    String    @unique @default(cuid())
  displayName     String    @default("")
  currentStreak   Int       @default(0)
  totalDaysWon            Int       @default(0)
  highestStreak           Int       @default(0)
  desensitizationPoints   Int       @default(0)
  lastCheckIn     DateTime?
  lastLoginAt     DateTime  @default(now())
  timezone        String    @default("UTC")
  createdAt       DateTime  @default(now())

  // Stripe
  stripeCustomerId     String? @unique
  stripeSubscriptionId String?
  subscriptionStatus   String  @default("trialing") // trialing, active, canceled, completed, pending_iap

  // RevenueCat (iOS IAP)
  revenuecatId          String?  @unique
  registrationPlatform  String   @default("web") // "web" | "ios"
  ageVerifiedAt         DateTime?

  // Push notifications
  pushToken             String?
  pushTokenPlatform     String?  // "ios" | "web"

  // Preferences
  hasCompletedOnboarding Boolean  @default(false)
  colorTheme           String    @default("slate")
  reminderTime         String?
  hideFromLeaderboard  Boolean   @default(false)
  displayNameChangedAt DateTime?
  completedAt          DateTime?

  // Referral tracking
  referredById    String?
  referredBy      User?      @relation("referrals", fields: [referredById], references: [id])
  referrals       User[]     @relation("referrals")
  lifetimeAccess  Boolean    @default(false)

  checkIns        CheckIn[]
  supportGiven    Support[] @relation("supporter")
  supportReceived Support[] @relation("receiver")
  referralRewardsGiven    ReferralReward[] @relation("referrer")
  referralRewardsReceived ReferralReward[] @relation("referred")
  urgeSurfEvents      UrgeSurfEvent[]
  desensitizationLogs DesensitizationLog[]
  bookmarks           Bookmark[]
  journalEntries      JournalEntry[]
  intimacyCheckIns    IntimacyCheckIn[]
  intimacyLogs        IntimacyLog[]
  assessmentScores    AssessmentScore[]
  partnershipsAsUser1 Partnership[] @relation("partnerUser1")
  partnershipsAsUser2 Partnership[] @relation("partnerUser2")
  sentPartnerMessages PartnerMessage[] @relation("messageSender")
  partnerQueue        PartnerQueue?
}

model CheckIn {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  date        DateTime @default(now())
  stayedStrong Boolean
  daysAdded   Int      @default(1)
}

model Affirmation {
  id     String @id @default(cuid())
  dayNum Int    @unique
  text   String
}

model DesensImage {
  id               String @id @default(cuid())
  dayNum           Int    @unique
  imageUrl         String
  overlayText      String
  difficulty       Int    @default(2) // 0=neutral(0pts), 1=easy(1pt), 2=medium(2pts), 3=hard(3pts)
  durationSeconds  Int    @default(15)
  textAppearAt     Int    @default(3)
  textDisappearAt  Int    @default(9)

  desensitizationLogs DesensitizationLog[]
}

model DesensitizationLog {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  imageId       String
  image         DesensImage @relation(fields: [imageId], references: [id])
  pointsEarned  Int
  feedbackScore Int?
  completedAt   DateTime    @default(now())

  @@index([userId])
}

model UrgeSurfEvent {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id])
  sessionDay         Int
  completedBreathing Boolean  @default(false)
  resumedExercise    Boolean  @default(false)
  createdAt          DateTime @default(now())
}

model Support {
  id          String   @id @default(cuid())
  supporterId String
  receiverId  String
  supporter   User     @relation("supporter", fields: [supporterId], references: [id])
  receiver    User     @relation("receiver", fields: [receiverId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([supporterId, receiverId, createdAt])
}

model Admin {
  id           String @id @default(cuid())
  username     String @unique
  passwordHash String
}

model ReferralReward {
  id            String   @id @default(cuid())
  referrerId    String
  referredId    String
  referrer      User     @relation("referrer", fields: [referrerId], references: [id])
  referred      User     @relation("referred", fields: [referredId], references: [id])
  creditDays    Int      @default(7) // 1 week = 7 days
  appliedAt     DateTime @default(now())
  stripeApplied Boolean  @default(false)

  @@unique([referrerId, referredId])
}

model Resource {
  id        String     @id @default(cuid())
  week      Int
  category  String     // 'studies' | 'drive' | 'intimacy' | 'wisdom'
  title     String
  source    String?
  summary   String
  link      String?
  createdAt DateTime   @default(now())

  bookmarks Bookmark[]

  @@index([week, category])
}

model Bookmark {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, resourceId])
  @@index([userId])
}

model IntimacyCheckIn {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id])
  dayNumber           Int      // totalDaysWon at time of check-in (10, 20, 30, ...)
  confidence          Int      // 1-10
  realAttraction      Int      // 1-10
  emotionalConnection Int      // 1-10
  createdAt           DateTime @default(now())

  @@unique([userId, dayNumber])
  @@index([userId])
}

model JournalEntry {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  mood      String?
  trigger   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}

model Partnership {
  id          String    @id @default(cuid())
  user1Id     String
  user2Id     String
  user1       User      @relation("partnerUser1", fields: [user1Id], references: [id])
  user2       User      @relation("partnerUser2", fields: [user2Id], references: [id])
  status      String    @default("active") // active, dissolved
  createdAt   DateTime  @default(now())
  dissolvedAt DateTime?
  messages    PartnerMessage[]

  @@unique([user1Id, user2Id])
  @@index([user1Id, status])
  @@index([user2Id, status])
}

model PartnerMessage {
  id            String      @id @default(cuid())
  partnershipId String
  partnership   Partnership @relation(fields: [partnershipId], references: [id])
  senderId      String
  sender        User        @relation("messageSender", fields: [senderId], references: [id])
  type          String      @default("message") // message, nudge
  content       String      @db.VarChar(500)
  readAt        DateTime?
  createdAt     DateTime    @default(now())
  reports       MessageReport[]

  @@index([partnershipId, createdAt])
}

model MessageReport {
  id         String         @id @default(cuid())
  messageId  String
  message    PartnerMessage @relation(fields: [messageId], references: [id])
  reporterId String
  reason     String
  createdAt  DateTime       @default(now())

  @@index([messageId])
}

model PartnerQueue {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model IntimacyLog {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id])
  date             DateTime
  erectionQuality  Int      // 1-5
  stayingPower     String   // "less-than-1min" | "1-5min" | "5-15min" | "15-30min" | "30-plus"
  presence         Int      // 1-5
  enjoyment        Int      // 1-5
  connection       Int      // 1-5
  notes            String?
  createdAt        DateTime @default(now())

  @@index([userId, date])
}

model AssessmentScore {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  responses  Json     // array of 18 ints, each 1-7
  totalScore Int
  takenAt    DateTime @default(now())
  milestone  String   // "baseline" | "day30" | "day90" | "day180" | "day365"

  @@index([userId, takenAt])
}
