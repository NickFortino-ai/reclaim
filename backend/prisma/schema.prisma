generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String    @id @default(cuid())
  accessCode      String    @unique
  referralCode    String    @unique @default(cuid())
  displayName     String    @default("")
  currentStreak   Int       @default(0)
  totalDaysWon            Int       @default(0)
  desensitizationPoints   Int       @default(0)
  lastCheckIn     DateTime?
  lastLoginAt     DateTime  @default(now())
  createdAt       DateTime  @default(now())

  // Stripe
  stripeCustomerId     String? @unique
  stripeSubscriptionId String?
  subscriptionStatus   String  @default("trialing") // trialing, active, canceled, completed

  // Preferences
  colorTheme  String    @default("slate")
  completedAt DateTime?

  // Referral tracking
  referredById    String?
  referredBy      User?      @relation("referrals", fields: [referredById], references: [id])
  referrals       User[]     @relation("referrals")
  lifetimeAccess  Boolean    @default(false)

  checkIns        CheckIn[]
  supportGiven    Support[] @relation("supporter")
  supportReceived Support[] @relation("receiver")
  referralRewardsGiven    ReferralReward[] @relation("referrer")
  referralRewardsReceived ReferralReward[] @relation("referred")
  urgeSurfEvents      UrgeSurfEvent[]
  desensitizationLogs DesensitizationLog[]
  bookmarks           Bookmark[]
  journalEntries      JournalEntry[]
}

model CheckIn {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  date        DateTime @default(now())
  stayedStrong Boolean
  daysAdded   Int      @default(1)
}

model Affirmation {
  id     String @id @default(cuid())
  dayNum Int    @unique
  text   String
}

model DesensImage {
  id          String @id @default(cuid())
  dayNum      Int    @unique
  imageUrl    String
  overlayText String
  difficulty  Int    @default(2) // 0=neutral(0pts), 1=easy(1pt), 2=medium(2pts), 3=hard(3pts)

  desensitizationLogs DesensitizationLog[]
}

model DesensitizationLog {
  id           String      @id @default(cuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id])
  imageId      String
  image        DesensImage @relation(fields: [imageId], references: [id])
  pointsEarned Int
  completedAt  DateTime    @default(now())

  @@index([userId])
}

model UrgeSurfEvent {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id])
  sessionDay         Int
  completedBreathing Boolean  @default(false)
  resumedExercise    Boolean  @default(false)
  createdAt          DateTime @default(now())
}

model Support {
  id          String   @id @default(cuid())
  supporterId String
  receiverId  String
  supporter   User     @relation("supporter", fields: [supporterId], references: [id])
  receiver    User     @relation("receiver", fields: [receiverId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([supporterId, receiverId, createdAt])
}

model Admin {
  id           String @id @default(cuid())
  username     String @unique
  passwordHash String
}

model ReferralReward {
  id            String   @id @default(cuid())
  referrerId    String
  referredId    String
  referrer      User     @relation("referrer", fields: [referrerId], references: [id])
  referred      User     @relation("referred", fields: [referredId], references: [id])
  creditDays    Int      @default(7) // 1 week = 7 days
  appliedAt     DateTime @default(now())
  stripeApplied Boolean  @default(false)

  @@unique([referrerId, referredId])
}

model Resource {
  id        String     @id @default(cuid())
  week      Int
  category  String     // 'studies' | 'drive' | 'intimacy' | 'wisdom'
  title     String
  source    String?
  summary   String
  link      String?
  createdAt DateTime   @default(now())

  bookmarks Bookmark[]

  @@index([week, category])
}

model Bookmark {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([userId, resourceId])
  @@index([userId])
}

model JournalEntry {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  content   String
  mood      String?
  trigger   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
}
